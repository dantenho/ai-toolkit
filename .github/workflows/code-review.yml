# ============================================================================
# Automated Code Review Workflow Using AI Assistants
# ============================================================================
# This workflow orchestrates multiple AI-powered code review tools to provide
# comprehensive automated code analysis on pull requests. It integrates:
# - Cursor Bot (AI code review)
# - Google Gemini AI (code analysis and suggestions)
# - GitHub Copilot CLI (code explanations)
# - Security scanning tools (Trivy, Semgrep, Bandit)
# - Dependency vulnerability scanning (Snyk, Dependency Review)
# - CodeRabbit AI (automated PR reviews)
# - CircleCI integration (external CI pipeline triggering)
# - Jules.MD (documentation review)
#
# The workflow runs on PR events and provides detailed feedback through
# GitHub comments and security alerts.
# ============================================================================
name: AI Code Review

# Workflow trigger configuration
on:
  # Trigger on pull request events to main/master branches
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened] # Trigger on PR open, update, or reopen
  # Weekly scheduled security scan (Monday at 2 AM UTC)
  schedule:
    - cron: "0 2 * * 1"
  # Allow manual workflow dispatch for on-demand reviews
  workflow_dispatch:

# Default job configuration applied to all jobs
defaults:
  run:
    shell: bash # Use bash shell for consistent behavior across platforms
    timeout-minutes: 30 # Prevent jobs from hanging indefinitely

jobs:
  # ========================================================================
  # Cursor Bot Code Review Job
  # ========================================================================
  # Placeholder job for Cursor AI integration. This job prepares the
  # environment and can be extended with actual Cursor Bot API calls
  # when the integration becomes available.
  # ========================================================================
  cursor-review:
    name: Cursor Bot Review
    runs-on: ubuntu-latest
    # Skip draft PRs to save CI resources
    if: github.event.pull_request.draft == false
    # Required permissions for PR comments and code access
    permissions:
      contents: read # Read repository contents
      pull-requests: write # Post review comments on PRs
      issues: write # Create/update issues if needed
    timeout-minutes: 15 # Job timeout to prevent hanging
    steps:
      - name: Checkout repository # Get PR code for review
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }} # Checkout PR branch
          fetch-depth: 0 # Full history for context

      - name: Set up Python 3.11 # Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv # Package manager
        run: pip install uv

      - name: Sync dependencies # Install project dependencies
        if: hashFiles('pyproject.toml') != ''
        run: uv sync

      - name: Run Cursor Bot Review # Placeholder for Cursor AI integration
        # Note: Replace with actual Cursor Bot API call when available
        run: |
          echo "Cursor Bot review would run here"
          echo "PR: ${{ github.event.pull_request.number }}"
          echo "Files changed: ${{ github.event.pull_request.changed_files }}"
        continue-on-error: true

  # Gemini Code Assistant review
  gemini-review:
    name: Gemini Code Assistant Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false # Skip draft PRs
    steps:
      - name: Checkout repository # Get PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Set up Python 3.11 # Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies # Install Google GenAI SDK
        run: |
          pip install google-generativeai
          pip install requests

      - name: Get changed files # List files changed in PR
        id: changed-files
        run: |
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
          echo "files=$(cat changed_files.txt | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

      - name: Run Gemini Code Review # Review code using Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # API key from secrets
        run: |
          python3 << 'EOF'
          import os
          import google.generativeai as genai

          api_key = os.getenv('GEMINI_API_KEY')
          if not api_key:
              print("GEMINI_API_KEY not found")
              exit(1)

          genai.configure(api_key=api_key)
          model = genai.GenerativeModel('gemini-pro')

          # Read changed files
          try:
              with open('changed_files.txt', 'r') as f:
                  files = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print("No changed files found")
              exit(0)

          # Review each file
          for file_path in files:
              if file_path.endswith(('.py', '.js', '.ts', '.java', '.cpp', '.c')):
                  try:
                      with open(file_path, 'r') as f:
                          content = f.read()
                      
                      prompt = f"Review this code for bugs, security issues, and improvements:\n\n{content}"
                      response = model.generate_content(prompt)
                      print(f"Review for {file_path}:\n{response.text}\n")
                  except Exception as e:
                      print(f"Error reviewing {file_path}: {e}")
          EOF
        continue-on-error: true

      - name: Post review comment # Post review results as PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– Comprehensive AI Code Review completed:\n\n- âœ… Gemini AI Analysis\n- ðŸ”’ Security Scanning (Trivy, Semgrep, Bandit)\n- ðŸ“¦ Dependency Review\n- ðŸ° CodeRabbit AI Review\n- ðŸ“š Documentation Review\n- ðŸ”„ CircleCI Integration\n\nCheck the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed feedback.'
            })

  # GitHub Copilot CLI integration
  copilot-review:
    name: GitHub Copilot Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Copilot Code Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth login --with-token <<< "$GITHUB_TOKEN"
          git diff --name-only HEAD~1 | while read file; do
            if [[ -f "$file" ]]; then
              echo "Reviewing $file with Copilot"
              gh copilot explain "$file" || echo "Copilot review failed for $file"
            fi
          done
        continue-on-error: true

  # Security scanning with multiple tools
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Semgrep security scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Run Bandit security linter
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true
        continue-on-error: true

  # Dependency scanning
  dependency-scan:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  # CodeRabbit AI review
  coderabbit-review:
    name: CodeRabbit AI Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: CodeRabbit Review
        uses: coderabbitai/coderabbit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true

  # CircleCI integration trigger
  circleci-trigger:
    name: Trigger CircleCI
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Trigger CircleCI Pipeline
        run: |
          curl -X POST \
            -H "Circle-Token: ${{ secrets.CIRCLECI_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "branch": "${{ github.event.pull_request.head.ref }}",
              "parameters": {
                "pr_number": ${{ github.event.pull_request.number }},
                "triggered_by": "github_actions"
              }
            }' \
            "https://circleci.com/api/v2/project/github/${{ github.repository }}/pipeline"
        continue-on-error: true

  # Jules.MD documentation review
  jules-md-review:
    name: Jules.MD Documentation Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for documentation changes
        id: docs-changed
        run: |
          if git diff --name-only HEAD~1 | grep -E '\.(md|rst|txt)$'; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Jules.MD Review
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "Jules.MD would review documentation changes here"
          git diff --name-only HEAD~1 | grep -E '\.(md|rst|txt)$' | while read file; do
            echo "Reviewing documentation: $file"
            # Placeholder for Jules.MD API integration
          done
        continue-on-error: true
